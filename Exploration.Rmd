---
title: "Control data analysis workbook"
output: html_notebook
---

# Tidy up ICAP data
This code takes in combined .csv files from the ICAP (with Y and time), tidies them up a bit and writes out new files and writes them in to the pivoted folder within rawdat
```{r, warning=FALSE, message = FALSE}
source("SourceCode/extract_and_organize_ICAPdata09012020.R")
```



Next steps, plot out a few samples and decide which time block to use for getting values
Make a list of samples that I think I can get decent data for

# What samples can I get good data for?
will make into a behind the scenes R script for getting total signal for the chunk of time
good time interval is 40 to 95 seconds
pick a blank, get names that make some sense, color by which are bigger than the blank
Std_0nM is a good blank one

```{r, warning=FALSE, message = FALSE}
# libraries
library(tidyverse)

# direct to folder with pivoted data
filenames <- list.files("RawDat/ICAP_run_20200901/Pivoted/", full.names = TRUE)

#load data, combine into one big DF
dat <- list()
for (i in 1:length(filenames)){
  dat[[i]] <- read_csv(filenames[i])
}
dat <- do.call(rbind, dat)
```

# Attach the meta info to the sample id so we can step through them and see if they make sense
```{r, warning=FALSE, message = FALSE}
meta_dat <- read_csv("MetaData/SampInfoNew.csv")%>%
  mutate(descript_ID = paste0(`Sample ID`, Replicate, `Fraction ID`)) %>%
  select(LC_ID, descript_ID, samplerun) %>%
  rename(sampleID = LC_ID)

descript_ID <- unique(meta_dat$descript_ID)

dat_2 <- dat %>%
  left_join(meta_dat, by = c("sampleID", "samplerun"))

```


```{r, warning=FALSE, message = FALSE}

# get only the samples and look at the 75As signal
dat_as <- dat %>%
  filter(element == "75As") %>%
#  filter(!str_detect(sampleID, "blank")) %>%
  filter(time > 40 & time < 95) %>%
  filter(str_detect(sampleID, "Smp") )

dat_as_pooled <- dat_as %>%
  group_by(sampleID, samplerun) %>%
  summarise(As_75_intensity = sum(intenstiy))

```

```{r, warning=FALSE, message = FALSE}
blank_as <- dat %>%
filter(element == "75As") %>%
filter(sampleID == "Std_0nM" & samplerun == "2020_09_01_KRH_AsTotal_5.csv") %>%
filter(time > 40 & time < 95) 

blank_as_pooled <- blank_as %>%
  group_by(sampleID, samplerun) %>%
  summarise(As_75_intensity = 3*sum(intenstiy))

dat_as_pooled_blank_subtracted <- dat_as %>%
  group_by(sampleID, samplerun) %>%
  summarise(As_75_intensity = sum(intenstiy)) %>%
  mutate(blank = blank_as_pooled$As_75_intensity[1]) %>%
  mutate(As_75_intensity_blanked = As_75_intensity-blank) %>%
  left_join(meta_dat)

g <- ggplot(data = dat_as_pooled_blank_subtracted, 
            aes(x = descript_ID, y = As_75_intensity_blanked)) +
  geom_bar(stat = "identity")+
  coord_flip()
g
  
```
# Check out just the bulk signal
```{r, warning=FALSE, message = FALSE}
dat_as_bulk <- dat_as_pooled_blank_subtracted %>%
  filter(str_detect(descript_ID, "bulk"))


g <- ggplot(data = dat_as_bulk, 
            aes(x = descript_ID, y = As_75_intensity_blanked)) +
  geom_bar(stat = "identity")+
  coord_flip()
g



```


